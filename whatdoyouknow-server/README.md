# whatdoyouknow-server

This repository contains the backend code for the **whatdoyouknow** project, handling core functionalities such as:

- **API Endpoints** â€“ Processes client requests and responses
- **Controllers** â€“ Implements business logic and request handling
- **Middleware** â€“ Ensures requests are authenticated before processing
- **WebSockets** â€“ Manages real-time communication between players
- **Database Functions** â€“ Handles data storage, retrieval, and migrations
- **GitHub Actions** â€“ Automates database migrations during deployments
- **ChatGPT Integration** â€“ Generates quiz questions dynamically

## ğŸ‹ Run locally with Docker

Follow these steps to set up and run the project using Docker.

#### ğŸ“‚ 1. Clone the Repository

```sh
git clone https://github.com/georgelopez7/whatdoyouknow-server.git
cd whatdoyouknow-server
```

#### ğŸ”‘ 2. Set OpenAI API Key

Before running the containers, add your OpenAI API Key in `docker-compose.yml`:

```yml
environment:
  OPENAI_API_KEY: "<your-openai-key-here>"
```

#### ğŸš€ 3. Start the Containers

Run the docker up command:

```sh
docker compose up
```

#### ğŸ—ï¸ 4. Services Started

Running the above command will spin up the following instances:

- **_whatdoyouknow-server_** â†’ Available at `localhost:8080`
- **_PostgreSQL Database_**

## ğŸ“¡ Websockets

Our project utilizes **[Gorilla WebSockets](https://github.com/gorilla/websocket)** to enable real-time communication between the backend and frontend. WebSockets facilitate actions such as:

- **Starting the game** â€“ Ensuring all players receive the game start signal simultaneously.
- **Displaying questions** â€“ Sending quiz questions to all connected players in a synchronized manner.
- **Presenting results** â€“ Broadcasting game results to all participants in real time.
- **and more...**

### ğŸ”— WebSocket Room Management

WebSocket connections are **managed and tagged using `roomCode`**, which uniquely identifies each game session. Players within the same `roomCode` receive synchronized updates.

### ğŸ”’ Allowed Origins

To enhance security, **only specified origins (IP addresses or domains) can connect to the WebSocket backend**. The allowed origins are set via the `ALLOWED_ORIGINS` environment variable.

`ALLOWED_ORIGINS=https://localhost:3000`

## ğŸ˜ PostgreSQL & ğŸ¦† Migrations

Our project uses **PostgreSQL** as the primary database to manage game data efficiently. It is responsible for:

- **Tracking players in specific rooms** â€“ Ensuring players are correctly associated with their respective game sessions.
- **Storing questions** â€“ Saving quiz questions generated by ChatGPT for each game.
- **Recording player answers** â€“ Logging responses to calculate and update scores in real time.

### ğŸ”„ Database Migrations with Goose

To manage database schema changes, we use **[Goose](https://github.com/pressly/goose)**, a lightweight migration tool for Go. Goose allows us to apply, rollback, and version control database migrations seamlessly.

### âœ¨ Running Migrations

Our project includes a **Makefile** to simplify database migration management. With a few simple commands, you can create, apply, and rollback migrations effortlessly.

#### ğŸ“Œ Creating a New Migration

Generate a new **migration file** by specifying a descriptive name:

```sh
make db-create-migration MIGRATION_NAME=add_players_table
```

#### ğŸš€ Running Migrations

Apply all pending migrations to update the database schema:

```sh
make db-migrate
```

#### ğŸƒğŸ»â€â™‚ï¸ Rolling Back the Last Migration

If needed, undo the most recent migration with:

```sh
make db-rollback-last-migration
```

## âš™ GitHub Actions

This project includes **GitHub Actions** to automate database migrations during deployment.

### How It Works

- When merging **master â†’ staging** or **staging â†’ production**, GitHub Actions automatically run the **database migrations.**
- Migrations are applied to the target database instance (e.g., **staging** or **production**) using **GitHub Secrets** for secure credentials.

## ğŸ–§ System Architecture

Hereâ€™s a visual representation of the system architecture:

![whatdoyouknow-server-diagram](https://github.com/user-attachments/assets/d9163eed-9de8-4566-a6e9-37ca2e95bde5)
