# whatdoyouknow-server

This repository contains the backend code for the **whatdoyouknow** project, handling core functionalities such as:

- **API Endpoints** – Processes client requests and responses
- **Controllers** – Implements business logic and request handling
- **Middleware** – Ensures requests are authenticated before processing
- **WebSockets** – Manages real-time communication between players
- **Database Functions** – Handles data storage, retrieval, and migrations
- **GitHub Actions** – Automates database migrations during deployments
- **ChatGPT Integration** – Generates quiz questions dynamically

## 🐋 Run locally with Docker

Follow these steps to set up and run the project using Docker.

#### 📂 1. Clone the Repository

```sh
git clone https://github.com/georgelopez7/whatdoyouknow-server.git
cd whatdoyouknow-server
```

#### 🔑 2. Set OpenAI API Key

Before running the containers, add your OpenAI API Key in `docker-compose.yml`:

```yml
environment:
  OPENAI_API_KEY: "<your-openai-key-here>"
```

#### 🚀 3. Start the Containers

Run the docker up command:

```sh
docker compose up
```

#### 🏗️ 4. Services Started

Running the above command will spin up the following instances:

- **_whatdoyouknow-server_** → Available at `localhost:8080`
- **_PostgreSQL Database_**

## 📡 Websockets

Our project utilizes **[Gorilla WebSockets](https://github.com/gorilla/websocket)** to enable real-time communication between the backend and frontend. WebSockets facilitate actions such as:

- **Starting the game** – Ensuring all players receive the game start signal simultaneously.
- **Displaying questions** – Sending quiz questions to all connected players in a synchronized manner.
- **Presenting results** – Broadcasting game results to all participants in real time.
- **and more...**

### 🔗 WebSocket Room Management

WebSocket connections are **managed and tagged using `roomCode`**, which uniquely identifies each game session. Players within the same `roomCode` receive synchronized updates.

### 🔒 Allowed Origins

To enhance security, **only specified origins (IP addresses or domains) can connect to the WebSocket backend**. The allowed origins are set via the `ALLOWED_ORIGINS` environment variable.

`ALLOWED_ORIGINS=https://localhost:3000`

## 🐘 PostgreSQL & 🦆 Migrations

Our project uses **PostgreSQL** as the primary database to manage game data efficiently. It is responsible for:

- **Tracking players in specific rooms** – Ensuring players are correctly associated with their respective game sessions.
- **Storing questions** – Saving quiz questions generated by ChatGPT for each game.
- **Recording player answers** – Logging responses to calculate and update scores in real time.

### 🔄 Database Migrations with Goose

To manage database schema changes, we use **[Goose](https://github.com/pressly/goose)**, a lightweight migration tool for Go. Goose allows us to apply, rollback, and version control database migrations seamlessly.

### ✨ Running Migrations

Our project includes a **Makefile** to simplify database migration management. With a few simple commands, you can create, apply, and rollback migrations effortlessly.

#### 📌 Creating a New Migration

Generate a new **migration file** by specifying a descriptive name:

```sh
make db-create-migration MIGRATION_NAME=add_players_table
```

#### 🚀 Running Migrations

Apply all pending migrations to update the database schema:

```sh
make db-migrate
```

#### 🏃🏻‍♂️ Rolling Back the Last Migration

If needed, undo the most recent migration with:

```sh
make db-rollback-last-migration
```

## ⚙ GitHub Actions

This project includes **GitHub Actions** to automate database migrations during deployment.

### How It Works

- When merging **master → staging** or **staging → production**, GitHub Actions automatically run the **database migrations.**
- Migrations are applied to the target database instance (e.g., **staging** or **production**) using **GitHub Secrets** for secure credentials.

## 🖧 System Architecture

Here’s a visual representation of the system architecture:

![whatdoyouknow-server-diagram](https://github.com/user-attachments/assets/d9163eed-9de8-4566-a6e9-37ca2e95bde5)
